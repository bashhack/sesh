# Sesh Development Scripts

This directory contains utility scripts to help with local development and testing of the `sesh` CLI tool. These scripts allow you to test AWS and TOTP flows without needing real AWS credentials or actual TOTP-enabled services.

## Scripts Overview

### üîê `mock-totp-service.go`
**Purpose**: Simulates an external TOTP service (like GitHub, Google, etc.) for testing the TOTP setup flow.

**Usage**:
```bash
# Generate a test TOTP QR code for default service
go run mock-totp-service.go

# Generate for a specific service
go run mock-totp-service.go GitHub

# Generate for a service with custom account
go run mock-totp-service.go Datadog ops@company.com
```

**What it does**:
- Generates a valid TOTP secret
- Displays a QR code in the terminal
- Shows the secret key for manual entry
- Provides setup/test commands for `sesh`

**When to use**: When testing `sesh --service totp --setup` flow without setting up a real TOTP service.

### üåê `mock-aws-cli.go`
**Purpose**: Simulates the AWS CLI for testing AWS MFA setup without real AWS credentials.

**Usage**:
```bash
# First build it
go build -o mock-bin/aws mock-aws-cli.go

# Then add to PATH (before real aws)
export PATH="$(pwd)/mock-bin:$PATH"

# Now sesh will use the mock AWS CLI
sesh --service aws --setup
```

**What it does**:
- Responds to AWS CLI commands (`sts get-caller-identity`, `iam list-mfa-devices`, etc.)
- Returns realistic JSON responses
- Validates MFA token format
- Supports error testing via environment variables

**Supported commands**:
- `aws sts get-caller-identity` - Returns mock user identity
- `aws sts get-session-token` - Generates mock temporary credentials
- `aws iam list-mfa-devices` - Lists mock MFA devices
- `aws configure get region` - Returns mock region

### üöÄ `setup-mock-aws.sh`
**Purpose**: Automates the setup of the mock AWS CLI for easy testing.

**Usage**:
```bash
./setup-mock-aws.sh
```

**What it does**:
- Builds the mock AWS CLI
- Creates `mock-bin` directory
- Provides copy-paste commands to update PATH
- Shows usage instructions
- Explains how to test error scenarios

### üîç `decode_metadata.go`
**Purpose**: Decodes and displays keychain metadata entries for debugging.

**Usage**:
```bash
go run decode_metadata.go
```

**What it does**:
- Reads base64-encoded metadata from keychain
- Decodes and pretty-prints the JSON structure
- Helps debug issues with stored TOTP/AWS entries

## Testing Workflows

### Testing AWS Setup Without Real AWS
```bash
# 1. Setup mock AWS CLI
./setup-mock-aws.sh
export PATH="$(pwd)/mock-bin:$PATH"

# 2. Run AWS setup
sesh --service aws --setup

# 3. When prompted for QR code, in another terminal:
go run mock-totp-service.go AWS

# 4. Test credential generation
sesh --service aws
```

### Testing TOTP Setup
```bash
# 1. Generate a mock TOTP service
go run mock-totp-service.go GitHub

# 2. In another terminal, setup TOTP
sesh --service totp --setup
# Enter "GitHub" as service name
# Choose QR scan or manual entry

# 3. Test TOTP generation
sesh --service totp --service-name GitHub
```

### Testing Error Scenarios
```bash
# Simulate AWS authentication failure
export MOCK_AWS_FAIL=true
sesh --service aws

# Simulate no MFA devices
export MOCK_AWS_NO_MFA=true
sesh --service aws --setup

# Reset to normal
unset MOCK_AWS_FAIL MOCK_AWS_NO_MFA
```

## Development Notes

### Why These Scripts?
- **Fast iteration**: Test changes without real AWS setup
- **Consistent testing**: Same mock data every time
- **Error testing**: Simulate various failure modes
- **No credentials needed**: Test without exposing real secrets

### Building Mock Scripts
Both Go scripts have dual `main` functions, so they must be run with `go run` or built separately:
```bash
# DON'T do this - will fail
go build ./scripts/...

# DO this instead
go run scripts/mock-totp-service.go
# OR
cd scripts && go build -o mock-totp mock-totp-service.go
```

### Cleanup
Remember to remove the mock AWS from your PATH when done:
```bash
# Remove mock from PATH
export PATH=${PATH#$(pwd)/mock-bin:}

# Verify real AWS is back
which aws  # Should show /usr/local/bin/aws or similar
```

## Tips
- The mock scripts generate realistic but fake data - perfect for testing
- QR codes generated by `mock-totp-service.go` are real, scannable TOTP codes
- Mock AWS CLI delays responses slightly to simulate network latency
- All mock data uses consistent test values for reproducible testing